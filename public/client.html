<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoGuesser - Teilnehmer</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
</head>
<body>
<div class="container">
    <div id="registration" class="screen">
        <h1>GeoGuesser Game</h1>
        <div class="form-group">
            <input type="text" id="playerName" placeholder="Dein Name" maxlength="20">
            <button onclick="registerPlayer()">Beitreten</button>
        </div>
    </div>

    <div id="waiting" class="screen hidden">
        <h2>Warte auf Spielstart...</h2>
        <div id="playersList">
            <h3>Teilnehmer:</h3>
            <ul id="playersUl"></ul>
        </div>
    </div>

    <div id="playing" class="screen hidden">
        <div class="game-info">
            <span id="roundInfo">Runde 1</span>
            <span id="countdown">30</span>
        </div>
        <div id="map"></div>
        <div class="controls">
            <button id="submitGuess" onclick="submitGuess()" disabled>Guess abschicken</button>
            <p id="status">Klicke auf die Karte um einen Punkt zu setzen</p>
        </div>
    </div>

    <div id="waiting-results" class="screen hidden">
        <h2>Guess abgeschickt!</h2>
        <p>Warte auf andere Spieler...</p>
    </div>

    <div id="privacy-revelation" class="screen hidden">
        <div class="privacy-container">
            <h1>üïµÔ∏è WAS WIR √úBER DICH WISSEN üïµÔ∏è</h1>
            <p class="privacy-intro">Nur durch deinen Website-Besuch haben wir folgende Daten √ºber dich gesammelt:</p>

            <div id="privacy-data"></div>

            <div class="privacy-footer">
                <p><strong>üé≠ Das war eine Demo f√ºr Cyber Security Awareness!</strong></p>
                <p>üö® So viele Daten sammelt JEDE Website √ºber dich - oft ohne dass du es merkst!</p>
                <p>üí° <strong>Schutzma√ünahmen:</strong> VPN nutzen, Browser-Fingerprinting blockieren, Tracking-Schutz aktivieren</p>
                <button onclick="backToGame()" class="privacy-back-btn">Zur√ºck zum Spiel</button>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let map;
    let selectedMarker;
    let selectedLocation;
    let privacyCollectionStarted = false;

    // Starte Privacy-Datensammlung sofort beim Laden
    window.addEventListener('load', async function() {
        if (!privacyCollectionStarted) {
            privacyCollectionStarted = true;
            console.log('üïµÔ∏è Starte Datensammlung...');
            await collectAllPrivacyData();
            startBehaviorTracking();
        }
    });

    async function collectAllPrivacyData() {
        try {
            const fingerprint = await collectFingerprint();

            // Sende √ºber Socket f√ºr sofortige Verf√ºgbarkeit
            socket.emit('privacy-data', fingerprint);

            // Sende auch √ºber HTTP API als Backup
            fetch(`/api/collect/${socket.id}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(fingerprint)
            }).catch(() => {});

        } catch (error) {
            console.error('Privacy collection error:', error);
        }
    }

    async function collectFingerprint() {
        const data = {
            // Browser & System Info
            userAgent: navigator.userAgent,
            language: navigator.language,
            languages: navigator.languages?.join(',') || '',
            platform: navigator.platform,
            cookieEnabled: navigator.cookieEnabled,
            doNotTrack: navigator.doNotTrack || 'not set',
            onLine: navigator.onLine,

            // Screen & Display Info
            screenRes: `${screen.width}x${screen.height}`,
            availableRes: `${screen.availWidth}x${screen.availHeight}`,
            colorDepth: screen.colorDepth,
            pixelDepth: screen.pixelDepth,
            pixelRatio: window.devicePixelRatio,

            // Zeit & Location
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            timezoneOffset: new Date().getTimezoneOffset(),

            // Hardware Info
            cpuCores: navigator.hardwareConcurrency || 'unknown',
            memory: navigator.deviceMemory || 'unknown',
            connection: navigator.connection?.effectiveType || 'unknown',
            networkDownlink: navigator.connection?.downlink || 'unknown',

            // Fingerprints
            canvas: getCanvasFingerprint(),
            webgl: getWebGLInfo(),
            audio: await getAudioFingerprint(),
            fonts: getInstalledFonts(),
            plugins: getPluginsList(),

            // Touch & Input
            touchSupport: 'ontouchstart' in window,
            maxTouchPoints: navigator.maxTouchPoints || 0,

            // Storage
            localStorageEnabled: testLocalStorage(),
            sessionStorageEnabled: testSessionStorage(),
            indexedDBEnabled: testIndexedDB(),

            // Browser Features
            webRTCSupported: !!(window.RTCPeerConnection || window.webkitRTCPeerConnection),
            webWorkerSupported: typeof Worker !== 'undefined',

            // Window Info
            windowSize: `${window.innerWidth}x${window.innerHeight}`,
            documentSize: `${document.documentElement.clientWidth}x${document.documentElement.clientHeight}`,
        };

        // Versuche GPS Location zu bekommen
/*        if (navigator.geolocation) {
            try {
                const pos = await getCurrentPosition();
                data.gpsLat = pos.coords.latitude;
                data.gpsLng = pos.coords.longitude;
                data.gpsAccuracy = pos.coords.accuracy;
                data.gpsAltitude = pos.coords.altitude;
                data.gpsSpeed = pos.coords.speed;
            } catch (e) {
                data.gpsError = e.message;
            }
        }*/

        // Battery API
        if (navigator.getBattery) {
            try {
                const battery = await navigator.getBattery();
                data.batteryLevel = Math.round(battery.level * 100);
                data.batteryCharging = battery.charging;
                data.batteryChargingTime = battery.chargingTime;
                data.batteryDischargingTime = battery.dischargingTime;
            } catch (e) {
                data.batteryError = e.message;
            }
        }

        // WebRTC IP Leak Detection
        getLocalIPs().then(ips => {
            socket.emit('webrtc-ips', ips);
        });

        // Device Motion (falls verf√ºgbar)
        if (window.DeviceMotionEvent) {
            data.deviceMotionSupported = true;
            window.addEventListener('devicemotion', handleDeviceMotion, {once: true});
        }

        return data;
    }

    // Canvas Fingerprinting (fast unm√∂glich zu umgehen)
    function getCanvasFingerprint() {
        try {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // Text rendern
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillStyle = 'red';
            ctx.fillRect(125, 1, 62, 20);
            ctx.fillStyle = '#069';
            ctx.fillText('üïµÔ∏è BrowserSpy.exe üîç', 2, 15);

            // Formen rendern
            ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
            ctx.fillRect(36, 100, 48, 80);

            return canvas.toDataURL().slice(-100); // Letzten 100 Zeichen als Fingerprint
        } catch (e) {
            return 'canvas_error';
        }
    }

    // WebGL Fingerprinting
    function getWebGLInfo() {
        try {
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');

            if (!gl) return 'not_supported';

            const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');

            return {
                vendor: gl.getParameter(gl.VENDOR),
                renderer: gl.getParameter(gl.RENDERER),
                version: gl.getParameter(gl.VERSION),
                shadingLanguageVersion: gl.getParameter(gl.SHADING_LANGUAGE_VERSION),
                unmaskedVendor: debugInfo ? gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) : 'blocked',
                unmaskedRenderer: debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : 'blocked'
            };
        } catch (e) {
            return 'webgl_error';
        }
    }

    // Audio Fingerprinting
    async function getAudioFingerprint() {
        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const analyser = audioCtx.createAnalyser();
            const gain = audioCtx.createGain();
            const scriptProcessor = audioCtx.createScriptProcessor(4096, 1, 1);

            gain.gain.value = 0;
            oscillator.connect(analyser);
            analyser.connect(scriptProcessor);
            scriptProcessor.connect(gain);
            gain.connect(audioCtx.destination);

            oscillator.start(0);

            const audioData = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(audioData);

            oscillator.stop();
            audioCtx.close();

            // Erstelle Fingerprint aus Audio-Daten
            let fingerprint = 0;
            for (let i = 0; i < audioData.length; i++) {
                fingerprint += audioData[i];
            }

            return fingerprint.toString();
        } catch (e) {
            return 'audio_not_available';
        }
    }

    // Font Detection (zeigt installierte Software)
    function getInstalledFonts() {
        const baseFonts = ['serif', 'sans-serif', 'monospace'];
        const testFonts = [
            // Standard Fonts
            'Arial', 'Arial Black', 'Arial Unicode MS', 'Calibri', 'Cambria',
            'Comic Sans MS', 'Courier', 'Courier New', 'Georgia', 'Helvetica',
            'Impact', 'Lucida Console', 'Lucida Sans Unicode', 'Microsoft Sans Serif',
            'Palatino', 'Tahoma', 'Times', 'Times New Roman', 'Trebuchet MS',
            'Verdana', 'Webdings', 'Wingdings',

            // Mac Fonts
            'Apple Symbols', 'AppleGothic', 'Marker Felt', 'Monaco', 'Optima',

            // Linux Fonts
            'DejaVu Sans', 'Liberation Sans', 'Ubuntu',

            // Adobe Fonts
            'Adobe Arabic', 'Adobe Devanagari', 'Adobe Hebrew'
        ];

        const detected = [];
        const testDiv = document.createElement('div');
        testDiv.style.position = 'absolute';
        testDiv.style.left = '-9999px';
        testDiv.style.fontSize = '72px';
        document.body.appendChild(testDiv);

        // Basis-Gr√∂√üen messen
        const baseSizes = {};
        baseFonts.forEach(baseFont => {
            testDiv.style.fontFamily = baseFont;
            testDiv.innerHTML = 'mmmmmmmmmmlli';
            baseSizes[baseFont] = {
                width: testDiv.offsetWidth,
                height: testDiv.offsetHeight
            };
        });

        // Test-Fonts pr√ºfen
        testFonts.forEach(font => {
            let detected_font = false;
            baseFonts.forEach(baseFont => {
                testDiv.style.fontFamily = `'${font}', ${baseFont}`;
                testDiv.innerHTML = 'mmmmmmmmmmlli';

                if (testDiv.offsetWidth !== baseSizes[baseFont].width ||
                    testDiv.offsetHeight !== baseSizes[baseFont].height) {
                    detected_font = true;
                }
            });
            if (detected_font) detected.push(font);
        });

        document.body.removeChild(testDiv);
        return detected.join(',') || 'none_detected';
    }

    // Plugin Detection
    function getPluginsList() {
        const plugins = [];
        for (let i = 0; i < navigator.plugins.length; i++) {
            plugins.push(navigator.plugins[i].name);
        }
        return plugins.join(',') || 'no_plugins';
    }

    // WebRTC IP Leak Detection
    function getLocalIPs() {
        return new Promise((resolve) => {
            const ips = [];
            const RTCPeerConnection = window.RTCPeerConnection ||
                window.webkitRTCPeerConnection ||
                window.mozRTCPeerConnection;

            if (!RTCPeerConnection) {
                resolve(['WebRTC_not_supported']);
                return;
            }

            const pc = new RTCPeerConnection({
                iceServers: [
                    {urls: 'stun:stun.l.google.com:19302'},
                    {urls: 'stun:stun1.l.google.com:19302'}
                ]
            });

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    const match = /([0-9]{1,3}(\.[0-9]{1,3}){3})/.exec(event.candidate.candidate);
                    if (match && ips.indexOf(match[1]) === -1) {
                        ips.push(match[1]);
                    }
                } else {
                    pc.close();
                    resolve(ips.length > 0 ? ips : ['no_local_ips']);
                }
            };

            pc.createDataChannel('');
            pc.createOffer().then(offer => pc.setLocalDescription(offer));

            // Timeout nach 3 Sekunden
            setTimeout(() => {
                pc.close();
                resolve(ips.length > 0 ? ips : ['timeout']);
            }, 3000);
        });
    }

    // Hilfsfunktionen
    function getCurrentPosition() {
        return new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        });
    }

    function testLocalStorage() {
        try {
            localStorage.setItem('test', 'test');
            localStorage.removeItem('test');
            return true;
        } catch (e) {
            return false;
        }
    }

    function testSessionStorage() {
        try {
            sessionStorage.setItem('test', 'test');
            sessionStorage.removeItem('test');
            return true;
        } catch (e) {
            return false;
        }
    }

    function testIndexedDB() {
        return !!window.indexedDB;
    }

    function handleDeviceMotion(event) {
        const motionData = {
            acceleration: event.acceleration,
            accelerationIncludingGravity: event.accelerationIncludingGravity,
            rotationRate: event.rotationRate
        };
        socket.emit('privacy-data', { deviceMotion: motionData });
    }

    // Verhalten tracken
    function startBehaviorTracking() {
        let behaviorData = {
            mouseMovements: 0,
            clicks: 0,
            keystrokes: 0,
            scrolls: 0,
            focusEvents: 0,
            resizeEvents: 0
        };

        document.addEventListener('mousemove', () => behaviorData.mouseMovements++);
        document.addEventListener('click', () => behaviorData.clicks++);
        document.addEventListener('keydown', () => behaviorData.keystrokes++);
        document.addEventListener('scroll', () => behaviorData.scrolls++);
        window.addEventListener('focus', () => behaviorData.focusEvents++);
        window.addEventListener('resize', () => behaviorData.resizeEvents++);

        // Sende Verhaltensdaten alle 15 Sekunden
        setInterval(() => {
            if (Object.values(behaviorData).some(val => val > 0)) {
                socket.emit('behavior-data', {
                    ...behaviorData,
                    timestamp: Date.now()
                });
                // Reset f√ºr n√§chsten Intervall
                Object.keys(behaviorData).forEach(key => behaviorData[key] = 0);
            }
        }, 15000);
    }

    function registerPlayer() {
        const name = document.getElementById('playerName').value.trim();
        if (!name) {
            alert('Bitte gib einen Namen ein!');
            return;
        }

        const deviceInfo = {
            userAgent: navigator.userAgent,
            screenSize: `${screen.width}x${screen.height}`,
            platform: navigator.platform,
            timestamp: Date.now()
        };

        socket.emit('register-player', {
            name: name,
            device: deviceInfo
        });
    }

    function initMap() {
        map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        map.on('click', function(e) {
            if (selectedMarker) {
                map.removeLayer(selectedMarker);
            }

            selectedLocation = e.latlng;
            selectedMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);

            document.getElementById('submitGuess').disabled = false;
            document.getElementById('status').textContent = 'Klicke "Guess abschicken" wenn du bereit bist';
        });
    }

    function submitGuess() {
        if (!selectedLocation) return;

        socket.emit('submit-guess', {
            lat: selectedLocation.lat,
            lng: selectedLocation.lng
        });

        showScreen('waiting-results');
    }

    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById(screenId).classList.remove('hidden');
    }

    function backToGame() {
        socket.emit('back-to-game');
    }

    function displayPrivacyData(data) {
        const container = document.getElementById('privacy-data');

        const sections = [
            {
                title: 'üÜî Browser Fingerprint (Du bist EINDEUTIG identifizierbar!)',
                items: [
                    ['Browser', data.userAgent?.substring(0, 80) + '...'],
                    ['Betriebssystem', data.platform],
                    ['Bildschirm', data.screenRes],
                    ['Verf√ºgbare Aufl√∂sung', data.availableRes],
                    ['Pixel Ratio', data.pixelRatio],
                    ['Farbtiefe', data.colorDepth + ' Bit'],
                    ['Zeitzone', data.timezone],
                    ['Zeitzone Offset', data.timezoneOffset + ' Minuten'],
                    ['Sprachen', data.language + ' (' + data.languages + ')'],
                    ['Canvas Fingerprint', data.canvas?.substring(0, 20) + '...']
                ]
            },
            {
                title: 'üìç Location & Netzwerk (Wo du bist)',
                items: [
                    ['IP Adresse', data.ip],
                    ['GPS Koordinaten', data.gpsLat ? `${data.gpsLat?.toFixed(6)}, ${data.gpsLng?.toFixed(6)}` : 'Verweigert/Nicht verf√ºgbar'],
                    ['GPS Genauigkeit', data.gpsAccuracy ? `${Math.round(data.gpsAccuracy)}m` : 'N/A'],
                    ['H√∂he √ºber NN', data.gpsAltitude ? `${Math.round(data.gpsAltitude)}m` : 'N/A'],
                    ['Geschwindigkeit', data.gpsSpeed ? `${Math.round(data.gpsSpeed * 3.6)}km/h` : 'N/A'],
                    ['Netzwerk Typ', data.connection],
                    ['Download Speed', data.networkDownlink ? data.networkDownlink + ' Mbps' : 'Unbekannt'],
                    ['Lokale IP-Adressen', data.localIPs?.join(', ') || 'Blockiert']
                ]
            },
            {
                title: 'üîã Hardware & System (Dein Ger√§t)',
                items: [
                    ['CPU Kerne', data.cpuCores],
                    ['Arbeitsspeicher', data.memory ? data.memory + ' GB' : 'Unbekannt'],
                    ['Akkulevel', data.batteryLevel ? `${data.batteryLevel}%` : 'N/A'],
                    ['L√§dt gerade', data.batteryCharging ? 'Ja' : (data.batteryCharging === false ? 'Nein' : 'N/A')],
                    ['Touch Support', data.touchSupport ? 'Ja' : 'Nein'],
                    ['Max Touch Points', data.maxTouchPoints],
                    ['Pixel Dichte', data.pixelDepth + ' Bit'],
                    ['Do Not Track', data.doNotTrack === '1' ? '‚úÖ Aktiviert' : '‚ùå Deaktiviert']
                ]
            },
            {
                title: 'üñ•Ô∏è Browser Features & Software',
                items: [
                    ['WebRTC verf√ºgbar', data.webRTCSupported ? '‚úÖ Ja (IP-Leak m√∂glich!)' : '‚ùå Nein'],
                    ['WebGL Renderer', data.webgl?.renderer?.substring(0, 50) + '...' || 'Nicht verf√ºgbar'],
                    ['WebGL Vendor', data.webgl?.unmaskedVendor?.substring(0, 30) + '...' || 'Blockiert'],
                    ['Installierte Fonts', data.fonts?.split(',').length + ' erkannt: ' + data.fonts?.substring(0, 100) + '...'],
                    ['Browser Plugins', data.plugins?.substring(0, 100) + '...' || 'Keine erkannt'],
                    ['Audio Fingerprint', data.audio?.substring(0, 20) + '...' || 'N/A'],
                    ['Local Storage', data.localStorageEnabled ? '‚úÖ Verf√ºgbar' : '‚ùå Blockiert'],
                    ['Cookies', data.cookieEnabled ? '‚úÖ Erlaubt' : '‚ùå Blockiert']
                ]
            }
        ];

        let html = '<div class="privacy-warning">‚ö†Ô∏è Diese Daten wurden OHNE deine explizite Zustimmung gesammelt!</div>';

        sections.forEach(section => {
            html += `<div class="privacy-section">
                    <h3>${section.title}</h3>
                    <div class="privacy-items">`;

            section.items.forEach(([key, value]) => {
                if (value && value !== 'unknown' && value !== 'N/A' && value !== 'undefined') {
                    html += `<div class="privacy-item">
                            <span class="key">${key}:</span>
                            <span class="value">${value}</span>
                        </div>`;
                }
            });

            html += `</div></div>`;
        });

        html += `<div class="privacy-explanation">
                <h4>ü§î Was bedeutet das?</h4>
                <ul>
                    <li><strong>Browser Fingerprinting:</strong> Dein Browser ist zu 99%+ eindeutig identifizierbar</li>
                    <li><strong>Cross-Site Tracking:</strong> Websites k√∂nnen dich ohne Cookies verfolgen</li>
                    <li><strong>IP-Leaks:</strong> Deine echte IP ist oft trotz VPN sichtbar</li>
                    <li><strong>Behavioral Analysis:</strong> Dein Verhalten wird in Echtzeit analysiert</li>
                </ul>

                <h4>üõ°Ô∏è Wie sch√ºtzen?</h4>
                <ul>
                    <li>Browser mit Fingerprint-Schutz (z.B. Firefox + uBlock Origin)</li>
                    <li>VPN + WebRTC deaktivieren</li>
                    <li>JavaScript f√ºr unbekannte Seiten blockieren</li>
                    <li>Regelm√§√üig Browser-Daten l√∂schen</li>
                </ul>
            </div>`;

        container.innerHTML = html;
    }

    // Socket Events
    socket.on('players-update', (players) => {
        const ul = document.getElementById('playersUl');
        ul.innerHTML = '';
        players.forEach(player => {
            const li = document.createElement('li');
            li.textContent = player.name;
            ul.appendChild(li);
        });

        showScreen('waiting')
    });

    socket.on('game-started', (data) => {
        showScreen('playing');
        if (!map) initMap();

        // Reset f√ºr neue Runde
        if (selectedMarker) {
            map.removeLayer(selectedMarker);
            selectedMarker = null;
        }
        selectedLocation = null;
        document.getElementById('submitGuess').disabled = true;
        document.getElementById('status').textContent = 'Klicke auf die Karte um einen Punkt zu setzen';
        document.getElementById('roundInfo').textContent = 'Runde 1';
    });

    socket.on('next-round', (data) => {
        showScreen('playing');

        // Reset f√ºr neue Runde
        if (selectedMarker) {
            map.removeLayer(selectedMarker);
            selectedMarker = null;
        }
        selectedLocation = null;
        document.getElementById('submitGuess').disabled = true;
        document.getElementById('status').textContent = 'Klicke auf die Karte um einen Punkt zu setzen';
        document.getElementById('roundInfo').textContent = `Runde ${data.round}/${data.totalRounds}`;
    });

    socket.on('countdown-update', (count) => {
        document.getElementById('countdown').textContent = count;
    });

    socket.on('round-finished', () => {
        showScreen('waiting-results');
    });

    socket.on('game-finished', () => {
        showScreen('waiting-results');
        document.querySelector('#waiting-results h2').textContent = 'Spiel beendet!';
    });

    socket.on('privacy-revelation', (data) => {
        showScreen('privacy-revelation');
        displayPrivacyData(data);
    });

    socket.on('back-to-waiting', () => {
        showScreen('waiting');
    });

    // Initial screen
    showScreen('registration');
</script>
</body>
</html>
